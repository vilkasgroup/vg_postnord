{% form_theme vgPostnordBookingEditForm '@PrestaShop/Admin/TwigTemplateForm/prestashop_ui_kit.html.twig' %}

{% block vgPostnordBookingEditForm %}
  {{ form_start(vgPostnordBookingEditForm) }}
    <div class="card">
      <h3 class="card-header">
        <i class="material-icons">pencil</i>
        {{ 'Postnord Booking'|trans({}, 'Modules.Vgpostnord.Admin') }}
      </h3>
      <div class="card-block row" id="vg_postnord_edit_booking" data-ajaxurl="{{ajaxurl}}">
        {# The style help the form looks better in PS 8. #}
        <div class="card-text" style="width:100%; margin:0 1rem 0;">
          {{ form_widget(vgPostnordBookingEditForm) }}
        </div>
      </div>
      <div class="card-footer">
        <a href="{{ path('admin_vg_postnord_list_action') }}" class="btn btn-outline-secondary">
          {{ 'Cancel'|trans({}, 'Admin.Actions') }}
        </a>
        <button class="btn btn-primary float-right ml-2" id="save-button">
          {{ 'Save'|trans({}, 'Admin.Actions') }}
        </button>
        <button class="btn btn-primary float-right ml-2" id="save-and-stay-button" name="save-and-stay">
          {{ 'Save & stay'|trans({}, 'Modules.Vgpostnord.Admin') }}
        </button>
        <button class="btn btn-primary float-right ml-2" id="save-and-go-to-order-button" name="save-and-go-to-order">
          {{ 'Save & go to order'|trans({}, 'Modules.Vgpostnord.Admin') }}
        </button>
      </div>
    </div>
  {{ form_end(vgPostnordBookingEditForm) }}
{% endblock %}

<script>
  let add_parcel_button = $("#vg_postnord_booking_add_parcel_button");
  let add_detailed_description_button = $('#vg_postnord_booking_customs_declaration_add_detailed_description');

  let parcel_count = parseInt($("#vg_postnord_booking_parcel_count").val());
  let new_parcels = 0;
  let content_line_count = parseInt($("#vg_postnord_booking_content_line_count").val());
  let new_content_lines = 0;

  let default_tariff_number = $("#vg_postnord_booking_default_tariff_number").val();

  add_parcel_button.click(function() {
    let i = parcel_count + new_parcels;
    new_parcels++;

    {# TODO: translations for labels #}
    {# this needs to be kept up to date with the type generated by VgPostnordParcelType #}
    let html = `
      <div class="form-group row">
        <label class="form-control-label required">${i}</label>
        <div class="col-sm">
         <div id="vg_postnord_booking_parcel_data_${i}">
           <div class="form-group row">
             <label class="form-control-label" for="vg_postnord_booking_parcel_data_${i}_weight">Weight</label>
             <div class="col-sm">
               <input type="text" id="vg_postnord_booking_parcel_data_${i}_grossWeight"
                      name="vg_postnord_booking[parcel_data][${i}][grossWeight]"
                      class="form-control">
             </div>
           </div>
           <div class="form-group row">
             <label class="form-control-label" for="vg_postnord_booking_parcel_data_${i}_height">Height (cm)</label>
             <div class="col-sm">
               <input type="text" id="vg_postnord_booking_parcel_data_${i}_height"
                      name="vg_postnord_booking[parcel_data][${i}][height]" class="form-control">
             </div>
           </div>
           <div class="form-group row">
             <label class="form-control-label" for="vg_postnord_booking_parcel_data_${i}_width">Width (cm)</label>
             <div class="col-sm">
               <input type="text" id="vg_postnord_booking_parcel_data_${i}_width"
                      name="vg_postnord_booking[parcel_data][${i}][width]" class="form-control">
             </div>
           </div>
           <div class="form-group row">
             <label class="form-control-label" for="vg_postnord_booking_parcel_data_${i}_length">Length (cm)</label>
             <div class="col-sm">
               <input type="text" id="vg_postnord_booking_parcel_data_${i}_length"
                      name="vg_postnord_booking[parcel_data][${i}][length]" class="form-control">
             </div>
           </div>
           <div class="form-group">
             <button type="button" id="vg_postnord_booking_parcel_data_${i}_remove_parcel_button"
                     name="vg_postnord_booking[parcel_data][${i}][remove_parcel_button]"
                     class="vg-postnord-remove-parcel btn btn-primary btn btn">Remove parcel</button>
           </div>
         </div>
        </div>
      </div>
    `;
    $("#vg_postnord_booking_parcel_data").append(html);
  });

  add_detailed_description_button.click(function() {
    let i = content_line_count + new_content_lines;
    new_content_lines++;

    {# this needs to kept up to date with the type generated by VgPostnordDetailedDescriptionType #}
    let html = `
      <div class="form-group row">
        <label class="form-control-label required">${i}</label>
        <div class="col-sm">
          <div id="vg_postnord_booking_customs_declaration_detailed_description_${i}">
            <div class="form-group row">
              <label class="form-control-label required"
                     for="vg_postnord_booking_customs_declaration_detailed_description_${i}_content">Detailed description of the content</label>
              <div class="col-sm">
                <input type="text" id="vg_postnord_booking_customs_declaration_detailed_description_${i}_content"
                       name="vg_postnord_booking[customs_declaration][detailed_description][${i}][content]" required="required"
                       class="form-control">
              </div>
            </div>
            <div class="form-group row">
              <label class="form-control-label required"
                     for="vg_postnord_booking_customs_declaration_detailed_description_${i}_quantity">Quantity</label>
              <div class="col-sm">
                <input type="text" id="vg_postnord_booking_customs_declaration_detailed_description_${i}_quantity"
                       name="vg_postnord_booking[customs_declaration][detailed_description][${i}][quantity]" required="required"
                       class="form-control">
              </div>
            </div>
            <div class="form-group row">
              <label class="form-control-label required"
                     for="vg_postnord_booking_customs_declaration_detailed_description_${i}_grossWeight">Weight (kg)</label>
              <div class="col-sm">
                <input type="text" id="vg_postnord_booking_customs_declaration_detailed_description_${i}_grossWeight"
                       name="vg_postnord_booking[customs_declaration][detailed_description][${i}][grossWeight]" required="required"
                       class="form-control">
              </div>
            </div>
            <div class="form-group row">
              <label class="form-control-label required"
                     for="vg_postnord_booking_customs_declaration_detailed_description_${i}_value">Value</label>
              <div class="col-sm">
                <input type="text" id="vg_postnord_booking_customs_declaration_detailed_description_${i}_value"
                       name="vg_postnord_booking[customs_declaration][detailed_description][${i}][value]" required="required"
                       class="form-control">
              </div>
            </div>
            <div class="form-group row">
              <label class="form-control-label required"
                     for="vg_postnord_booking_customs_declaration_detailed_description_${i}_tariffNumber">HS tariff number</label>
              <div class="col-sm">
                <input type="text" id="vg_postnord_booking_customs_declaration_detailed_description_${i}_tariffNumber"
                       name="vg_postnord_booking[customs_declaration][detailed_description][${i}][tariffNumber]" required="required"
                       class="form-control" value="${default_tariff_number}">
              </div>
            </div>
            <div class="form-group row">
              <label class="form-control-label required" for="vg_postnord_booking_customs_declaration_detailed_description_${i}_countryCode">Country code (ISO 3166)</label>
              <div class="col-sm">
                <input type="text" id="vg_postnord_booking_customs_declaration_detailed_description_${i}_countryCode"
                       name="vg_postnord_booking[customs_declaration][detailed_description][${i}][countryCode]" required="required"
                       class="form-control">
              </div>
            </div>
            <div class="form-group">
              <button type="button" id="vg_postnord_booking_customs_declaration_detailed_description_${i}_remove_detailed_description"
                      name="vg_postnord_booking[customs_declaration][detailed_description][${i}][remove_detailed_description]"
                      class="vg-postnord-remove-detailed-description btn btn-primary btn btn">Remove content line</button>
            </div>
          </div>
        </div>
      </div>
    `;

    $("#vg_postnord_booking_customs_declaration_detailed_description").append(html);
  });

  $("body").on("click", ".vg-postnord-remove-parcel, .vg-postnord-remove-detailed-description", function() {
    const parcelCount = $("#vg_postnord_booking_parcel_data > div").length;
    const isRemoveContentLineButton = $(this).hasClass("vg-postnord-remove-detailed-description");

    // don't allow deleting the last parcel
    if (isRemoveContentLineButton || parcelCount > 1) {
      $(this).parent().closest(".form-group.row").remove();
    }
  });
</script>
